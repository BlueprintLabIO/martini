# Migration to TypeScript-First Martini SDK Architecture

## Vision

Migrate the Martini web app from JavaScript + custom API to a modern TypeScript-first architecture using the Martini SDK exclusively, with instant developer feedback and true Hot Module Replacement.

---

## Goals

### Primary Goals
- **TypeScript Everywhere**: All user code is TypeScript, no JavaScript option
- **Martini SDK Only**: Remove custom `gameAPI` wrapper, use `@martini/phaser` directly
- **True HMR**: Preserve game state across code reloads
- **Instant Feedback**: Real-time type checking, formatting, and linting
- **Zero Config Multiplayer**: Auto-wired P2P via Trystero

### Non-Goals
- ❌ Backward compatibility with `window.scenes` API
- ❌ JavaScript support (TypeScript only)
- ❌ Custom backend for multiplayer (P2P only)

---

## Architecture Comparison

### Current (Before)
```
User writes JS → esbuild bundles → Sandbox executes
                                    ↓
                        Custom gameAPI wrapper
                                    ↓
                        Manual state sync via postMessage
```

### Target (After)
```
User writes TS → Biome formats → TypeScript worker checks
                      ↓
                 esbuild bundles (TS→JS)
                      ↓
                 Sandbox executes
                      ↓
            Martini SDK (defineGame + PhaserAdapter)
                      ↓
                 Auto-synced state via runtime
```

---

## Tech Stack

| Layer | Before | After |
|-------|--------|-------|
| **Language** | JavaScript | TypeScript only |
| **API** | `window.scenes` | `defineGame()` from Martini SDK |
| **Bundler** | esbuild (JS only) | esbuild (TS support) |
| **Editor** | CodeMirror (JS mode) | CodeMirror (TS mode) + Biome |
| **Type Checking** | None | TypeScript worker |
| **Formatting** | None | Biome WASM |
| **Multiplayer** | Custom placeholder | Trystero P2P |
| **State Sync** | Manual postMessage | PhaserAdapter automatic |
| **HMR** | Full reload (lose state) | Preserve state |

---

## Key Principles

1. **Clean Slate**: No backward compatibility, completely new API
2. **SDK-First**: Martini SDK is the only way to write games
3. **Developer Experience**: Instant feedback loop (format/lint/type-check)
4. **Security**: Keep sandbox iframe for isolation
5. **Performance**: Biome for speed, TypeScript worker for background checking

---

## Migration Phases

### Phase 1: SDK Foundation (3 days)
- Copy Martini browser bundle to web app
- Create TypeScript-only project templates
- Update bundle API to support TypeScript
- Wire Martini SDK in sandbox runtime
- **Deliverable**: Can create and run TypeScript + Martini SDK games

### Phase 2: Editor Experience (2 days)
- Add Biome WASM for format/lint
- TypeScript worker for diagnostics
- Show type errors inline in CodeMirror
- **Deliverable**: Real-time type checking and formatting

### Phase 3: Hot Module Replacement (2 days)
- State preservation protocol
- Hot reload on save
- Error recovery
- **Deliverable**: Code changes don't reset game state

### Phase 4: Polish & Documentation (1 day)
- Format on save toggle
- Better error messages with source maps
- Type hints on hover
- Migration guide for existing projects
- **Deliverable**: Production-ready developer experience

---

## Estimated Timeline

- **Total Duration**: ~8 days (1.5 weeks)
- **Team Size**: 1 developer
- **Risk Level**: Low (clean slate, no backward compat)

---

## Success Metrics

- ✅ All new projects use TypeScript + Martini SDK
- ✅ Type errors show in <200ms
- ✅ Format/lint completes in <50ms
- ✅ HMR preserves player positions/scores
- ✅ Zero manual state sync code in user games
- ✅ Multiplayer works P2P with no backend

---

## Breaking Changes

### For Existing Projects
- ⚠️ **API Change**: `window.scenes` → `defineGame()`
- ⚠️ **Language Change**: JavaScript → TypeScript required
- ⚠️ **File Structure**: Single file → Multi-file (game.ts, scene.ts, main.ts)

### Migration Path
1. Mark old projects as "legacy"
2. Provide "Convert to TypeScript" tool (future)
3. New projects use new stack only

---

## Next Steps

1. Read [Phase 1: SDK Foundation](2.sdk-foundation.md)
2. Implement phases sequentially
3. Test with real games after each phase
4. Document lessons learned

---

## Open Questions

- [ ] Should we provide automated migration for existing projects?
- [ ] Should we support multiple Phaser versions (3.x vs 4.x)?
- [ ] Should we add visual scene editor (drag-drop sprites)?

---

**Last Updated**: 2025-01-13
**Status**: Planning Phase
**Owner**: Development Team
