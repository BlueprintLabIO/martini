<!DOCTYPE html>
<html>
<head>
  <title>Martini v2 - Simple Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>
  <style>
    body { margin: 0; padding: 20px; font-family: sans-serif; }
    #info { margin-bottom: 10px; }
    button { margin: 5px; padding: 10px; }
  </style>
</head>
<body>
  <div id="info">
    <div>Role: <span id="role">Connecting...</span></div>
    <div>Player ID: <span id="playerId">...</span></div>
    <div>Room: demo-room-123</div>
  </div>
  <div id="game"></div>

  <script type="module">
    // Import from built packages
    import { defineGame, GameRuntime } from './core/dist/index.js';
    import { TrysteroTransport } from './transport-trystero/dist/index.js';
    import { PhaserAdapter } from './phaser/dist/index.js';

    // Define game logic (no networking code!)
    const gameLogic = defineGame({
      setup: ({ playerIds }) => ({
        players: Object.fromEntries(
          playerIds.map(id => [id, { score: 0 }])
        )
      }),

      actions: {
        // Users can still define game actions if they want
        collectCoin: {
          apply(state, playerId) {
            if (state.players[playerId]) {
              state.players[playerId].score += 1;
            }
          }
        }
      },

      onPlayerJoin(state, playerId) {
        state.players[playerId] = { score: 0 };
      },

      onPlayerLeave(state, playerId) {
        delete state.players[playerId];
      }
    });

    // Create transport
    const transport = new TrysteroTransport({
      roomId: 'demo-room-123',
      appId: 'martini-v2-demo'
    });

    // Wait a moment for transport to connect
    setTimeout(async () => {
      const isHost = transport.isHost();
      const playerId = transport.getPlayerId();

      document.getElementById('role').textContent = isHost ? 'Host' : 'Client';
      document.getElementById('playerId').textContent = playerId.substring(0, 8);

      // Create runtime
      const runtime = new GameRuntime(gameLogic, transport, {
        isHost,
        playerIds: isHost ? [playerId] : undefined
      });

      // Create Phaser game
      const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        parent: 'game',
        physics: {
          default: 'arcade',
          arcade: {
            gravity: { y: 0 }
          }
        },
        scene: {
          create: function() {
            this.adapter = new PhaserAdapter(runtime, this);

            // Create local player
            this.player = this.add.circle(400, 300, 20, isHost ? 0x00ff00 : 0x0000ff);
            this.physics.add.existing(this.player);

            // Track it! (automatically syncs across network)
            this.adapter.trackSprite(this.player, `player-${playerId}`);

            // Create remote players when they appear
            this.adapter.onChange((state) => {
              if (!state._sprites) return;

              for (const [key, data] of Object.entries(state._sprites)) {
                // Skip our own sprite
                if (key === `player-${playerId}`) continue;

                // Create remote sprite if it doesn't exist
                if (!this.remoteSprites) this.remoteSprites = {};
                if (!this.remoteSprites[key]) {
                  const sprite = this.add.circle(data.x, data.y, 20, 0xff0000);
                  this.remoteSprites[key] = sprite;
                  this.adapter.registerRemoteSprite(key, sprite);
                }
              }
            });

            // Controls
            this.cursors = this.input.keyboard.createCursorKeys();

            // Info text
            this.add.text(10, 10, isHost ? 'HOST (green)' : 'CLIENT (blue)', {
              fill: '#ffffff'
            });
          },

          update: function() {
            if (!this.player) return;

            // Only the host/owner controls their sprite
            // Phaser physics runs normally!
            const speed = 200;
            if (this.cursors.left.isDown) {
              this.player.body.setVelocityX(-speed);
            } else if (this.cursors.right.isDown) {
              this.player.body.setVelocityX(speed);
            } else {
              this.player.body.setVelocityX(0);
            }

            if (this.cursors.up.isDown) {
              this.player.body.setVelocityY(-speed);
            } else if (this.cursors.down.isDown) {
              this.player.body.setVelocityY(speed);
            } else {
              this.player.body.setVelocityY(0);
            }
          }
        }
      };

      const game = new Phaser.Game(config);
    }, 1000);
  </script>
</body>
</html>
