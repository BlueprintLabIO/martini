{"version":3,"file":"_server.ts-z6_1I4Dx.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/conversations/_id_/messages/_server.ts.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport { d as db, p as projects, c as conversations, b as chatMessages } from \"../../../../../../chunks/index3.js\";\nimport { eq } from \"drizzle-orm\";\nconst GET = async ({ params, locals }) => {\n  const { session, user } = await locals.safeGetSession();\n  if (!session || !user) {\n    return json({ error: \"Unauthorized\" }, { status: 401 });\n  }\n  const conversationId = params.id;\n  const [conversation] = await db.select({\n    conversation: conversations,\n    project: projects\n  }).from(conversations).innerJoin(projects, eq(conversations.projectId, projects.id)).where(eq(conversations.id, conversationId)).limit(1);\n  if (!conversation) {\n    return json({ error: \"Conversation not found\" }, { status: 404 });\n  }\n  if (conversation.project.userId !== user.id) {\n    return json({ error: \"Unauthorized\" }, { status: 403 });\n  }\n  const [messagesRow] = await db.select().from(chatMessages).where(eq(chatMessages.conversationId, conversationId)).limit(1);\n  if (!messagesRow) {\n    const [newRow] = await db.insert(chatMessages).values({\n      conversationId,\n      messages: []\n    }).returning();\n    return json({\n      messages: newRow.messages || []\n    });\n  }\n  return json({\n    messages: messagesRow.messages || []\n  });\n};\nconst POST = async ({ params, locals, request }) => {\n  const { session, user } = await locals.safeGetSession();\n  if (!session || !user) {\n    return json({ error: \"Unauthorized\" }, { status: 401 });\n  }\n  const conversationId = params.id;\n  const { messages } = await request.json();\n  if (!Array.isArray(messages)) {\n    return json({ error: \"Messages must be an array\" }, { status: 400 });\n  }\n  const [conversation] = await db.select({\n    conversation: conversations,\n    project: projects\n  }).from(conversations).innerJoin(projects, eq(conversations.projectId, projects.id)).where(eq(conversations.id, conversationId)).limit(1);\n  if (!conversation) {\n    return json({ error: \"Conversation not found\" }, { status: 404 });\n  }\n  if (conversation.project.userId !== user.id) {\n    return json({ error: \"Unauthorized\" }, { status: 403 });\n  }\n  const [messagesRow] = await db.select().from(chatMessages).where(eq(chatMessages.conversationId, conversationId)).limit(1);\n  if (messagesRow) {\n    await db.update(chatMessages).set({\n      messages,\n      // jsonb type\n      updatedAt: /* @__PURE__ */ new Date()\n    }).where(eq(chatMessages.conversationId, conversationId));\n  } else {\n    await db.insert(chatMessages).values({\n      conversationId,\n      messages\n    });\n  }\n  await db.update(conversations).set({ updatedAt: /* @__PURE__ */ new Date() }).where(eq(conversations.id, conversationId));\n  return json({\n    success: true,\n    messageCount: messages.length\n  });\n};\nexport {\n  GET,\n  POST\n};\n"],"names":[],"mappings":"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"}