{"version":3,"file":"_server.ts-Cn_mqTp3.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/projects/_server.ts.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport { d as db, p as projects, f as files } from \"../../../../chunks/index3.js\";\nimport { eq, desc } from \"drizzle-orm\";\nconst martiniTypeScriptStarter = [\n  {\n    path: \"/src/game.ts\",\n    content: `/**\n * Game Logic - Pure state management\n *\n * This file defines your game rules and state using Martini SDK.\n * No Phaser code here - just pure TypeScript!\n */\n\nimport { defineGame } from '@martini/phaser';\n\nexport const myGame = defineGame({\n  // Initial state setup\n  setup: ({ playerIds }) => ({\n    players: Object.fromEntries(\n      playerIds.map((id, index) => [\n        id,\n        {\n          x: 200 + index * 400,\n          y: 300,\n          score: 0,\n          velocity: { x: 0, y: 0 }\n        }\n      ])\n    ),\n    // Store player inputs (updated every frame)\n    inputs: {} as Record<string, { left: boolean; right: boolean; up: boolean }>\n  }),\n\n  // Actions - How state changes\n  actions: {\n    // Update player input\n    input: {\n      apply: (state, context, input) => {\n        state.inputs[context.targetId] = input;\n      }\n    },\n\n    // Increment score\n    addScore: {\n      apply: (state, context, points: number) => {\n        const player = state.players[context.targetId];\n        if (player) {\n          player.score += points;\n        }\n      }\n    }\n  },\n\n  // Player join/leave handlers\n  onPlayerJoin: (state, playerId) => {\n    const existingCount = Object.keys(state.players).length;\n    state.players[playerId] = {\n      x: 200 + existingCount * 400,\n      y: 300,\n      score: 0,\n      velocity: { x: 0, y: 0 }\n    };\n  },\n\n  onPlayerLeave: (state, playerId) => {\n    delete state.players[playerId];\n    delete state.inputs[playerId];\n  }\n});\n`\n  },\n  {\n    path: \"/src/scene.ts\",\n    content: `/**\n * Phaser Scene - Rendering and input\n *\n * This file handles all Phaser-specific rendering logic.\n * It reads from game state and submits actions.\n */\n\nimport Phaser from 'phaser';\nimport { PhaserAdapter } from '@martini/phaser';\nimport type { GameRuntime } from '@martini/phaser';\n\nexport function createGameScene(runtime: GameRuntime) {\n  return class GameScene extends Phaser.Scene {\n    adapter!: PhaserAdapter;\n    sprites: Map<string, Phaser.GameObjects.Sprite> = new Map();\n\n    create() {\n      // Initialize Phaser adapter\n      this.adapter = new PhaserAdapter(runtime, this);\n\n      // Expose for HMR (will be added in Phase 3)\n      if ((window as any).__HMR__) {\n        (window as any).__HMR__.adapter = this.adapter;\n      }\n\n      // Background\n      this.add.rectangle(400, 300, 800, 600, 0x87ceeb);\n\n      // Platform\n      const platform = this.add.rectangle(400, 550, 600, 20, 0x8b4513);\n      this.physics.add.existing(platform, true);\n\n      // UI\n      this.add.text(10, 10, 'Use Arrow Keys to Move', {\n        fontSize: '16px',\n        color: '#000000'\n      });\n\n      // Listen for state changes to create/update sprites\n      this.adapter.onChange((state) => {\n        for (const [playerId, player] of Object.entries(state.players)) {\n          if (!this.sprites.has(playerId)) {\n            // Create sprite\n            const color = playerId === this.adapter.getMyPlayerId() ? 0x00ff00 : 0xff0000;\n            const sprite = this.add.circle(player.x, player.y, 20, color);\n            this.physics.add.existing(sprite);\n            (sprite.body as Phaser.Physics.Arcade.Body).setCollideWorldBounds(true);\n            this.physics.add.collider(sprite, platform);\n\n            this.sprites.set(playerId, sprite);\n\n            // Track my sprite for auto-sync\n            if (playerId === this.adapter.getMyPlayerId()) {\n              this.adapter.trackSprite(sprite, \\`player-\\${playerId}\\`);\n            } else {\n              // Register remote sprite for interpolation\n              this.adapter.registerRemoteSprite(\\`player-\\${playerId}\\`, sprite);\n            }\n          }\n        }\n      });\n    }\n\n    update() {\n      // Smooth interpolation for remote players\n      this.adapter.updateInterpolation();\n\n      // Input handling\n      const cursors = this.input.keyboard!.createCursorKeys();\n      const mySprite = this.sprites.get(this.adapter.getMyPlayerId());\n\n      if (mySprite) {\n        // Apply physics\n        const body = mySprite.body as Phaser.Physics.Arcade.Body;\n        body.setVelocityX(0);\n\n        if (cursors.left.isDown) {\n          body.setVelocityX(-200);\n        } else if (cursors.right.isDown) {\n          body.setVelocityX(200);\n        }\n\n        if (cursors.up.isDown && body.touching.down) {\n          body.setVelocityY(-400);\n        }\n\n        // Send input state to other players\n        this.adapter.submitAction('input', {\n          left: cursors.left.isDown,\n          right: cursors.right.isDown,\n          up: cursors.up.isDown\n        });\n      }\n    }\n  };\n}\n`\n  },\n  {\n    path: \"/src/main.ts\",\n    content: `/**\n * Entry Point - Auto-wired by Martini\n *\n * This file is auto-generated and should rarely need editing.\n * It wires up the runtime, transport, and Phaser game.\n */\n\nimport Phaser from 'phaser';\nimport { GameRuntime, TrysteroTransport } from '@martini/phaser';\nimport { myGame } from './game';\nimport { createGameScene } from './scene';\n\n// Get multiplayer config from URL params\n// (Auto-injected by sandbox runtime)\nconst roomId = (window as any).__ROOM_ID__ || 'default-room';\nconst isHost = (window as any).__IS_HOST__ || false;\n\n// Create P2P transport\nconst transport = new TrysteroTransport({\n  roomId,\n  isHost,\n  appId: 'martini-game',\n  // Use HiveMQ public broker (more reliable than mosquitto/emqx)\n  relayUrls: ['wss://broker.hivemq.com:8884/mqtt']\n});\n\n// Create game runtime\nconst runtime = new GameRuntime(myGame, transport, { isHost });\n\n// Expose for HMR (will be added in Phase 3)\nif ((window as any).__HMR__) {\n  (window as any).__HMR__.runtime = runtime;\n}\n\n// Create Phaser game\nconst game = new Phaser.Game({\n  type: Phaser.AUTO,\n  width: 800,\n  height: 600,\n  parent: 'game',\n  backgroundColor: '#87ceeb',\n  physics: {\n    default: 'arcade',\n    arcade: {\n      gravity: { x: 0, y: 400 },\n      debug: false\n    }\n  },\n  scene: createGameScene(runtime)\n});\n\n// Notify parent that game is ready\nif (window.parent !== window) {\n  window.parent.postMessage({ type: 'READY' }, '*');\n}\n`\n  },\n  {\n    path: \"/tsconfig.json\",\n    content: `{\n  \"compilerOptions\": {\n    \"target\": \"ES2020\",\n    \"module\": \"ESNext\",\n    \"lib\": [\"ES2020\", \"DOM\"],\n    \"moduleResolution\": \"bundler\",\n    \"strict\": true,\n    \"esModuleInterop\": true,\n    \"skipLibCheck\": true,\n    \"forceConsistentCasingInFileNames\": true,\n    \"resolveJsonModule\": true,\n    \"isolatedModules\": true,\n    \"types\": [\"phaser\"]\n  },\n  \"include\": [\"src/**/*\"]\n}\n`\n  }\n];\nconst GET = async ({ locals }) => {\n  const { session, user } = await locals.safeGetSession();\n  if (!session || !user) {\n    return json({ error: \"Unauthorized\" }, { status: 401 });\n  }\n  const userProjects = await db.select().from(projects).where(eq(projects.userId, user.id)).orderBy(desc(projects.updatedAt));\n  return json({ projects: userProjects });\n};\nconst POST = async ({ request, locals }) => {\n  const { session, user } = await locals.safeGetSession();\n  if (!session || !user) {\n    return json({ error: \"Unauthorized\" }, { status: 401 });\n  }\n  const body = await request.json();\n  const { name } = body;\n  if (!name || typeof name !== \"string\" || name.trim().length === 0) {\n    return json({ error: \"Project name is required\" }, { status: 400 });\n  }\n  if (name.length > 100) {\n    return json({ error: \"Project name must be 100 characters or less\" }, { status: 400 });\n  }\n  const [project] = await db.insert(projects).values({\n    userId: user.id,\n    name: name.trim()\n  }).returning();\n  await db.insert(files).values(\n    martiniTypeScriptStarter.map((file) => ({\n      projectId: project.id,\n      path: file.path,\n      content: file.content\n    }))\n  );\n  return json({ project }, { status: 201 });\n};\nexport {\n  GET,\n  POST\n};\n"],"names":[],"mappings":";;;;;;;;AAGA,MAAM,wBAAwB,GAAG;AACjC,EAAE;AACF,IAAI,IAAI,EAAE,cAAc;AACxB,IAAI,OAAO,EAAE,CAAC;AACd;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH,EAAE;AACF,IAAI,IAAI,EAAE,eAAe;AACzB,IAAI,OAAO,EAAE,CAAC;AACd;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH,EAAE;AACF,IAAI,IAAI,EAAE,cAAc;AACxB,IAAI,OAAO,EAAE,CAAC;AACd;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH,EAAE;AACF,IAAI,IAAI,EAAE,gBAAgB;AAC1B,IAAI,OAAO,EAAE,CAAC;AACd;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACI,MAAC,GAAG,GAAG,OAAO,EAAE,MAAM,EAAE,KAAK;AAClC,EAAE,MAAM,EAAE,OAAO,EAAE,IAAI,EAAE,GAAG,MAAM,MAAM,CAAC,cAAc,EAAE;AACzD,EAAE,IAAI,CAAC,OAAO,IAAI,CAAC,IAAI,EAAE;AACzB,IAAI,OAAO,IAAI,CAAC,EAAE,KAAK,EAAE,cAAc,EAAE,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAC3D,EAAE;AACF,EAAE,MAAM,YAAY,GAAG,MAAM,EAAE,CAAC,MAAM,EAAE,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC,QAAQ,CAAC,MAAM,EAAE,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC;AAC7H,EAAE,OAAO,IAAI,CAAC,EAAE,QAAQ,EAAE,YAAY,EAAE,CAAC;AACzC;AACK,MAAC,IAAI,GAAG,OAAO,EAAE,OAAO,EAAE,MAAM,EAAE,KAAK;AAC5C,EAAE,MAAM,EAAE,OAAO,EAAE,IAAI,EAAE,GAAG,MAAM,MAAM,CAAC,cAAc,EAAE;AACzD,EAAE,IAAI,CAAC,OAAO,IAAI,CAAC,IAAI,EAAE;AACzB,IAAI,OAAO,IAAI,CAAC,EAAE,KAAK,EAAE,cAAc,EAAE,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAC3D,EAAE;AACF,EAAE,MAAM,IAAI,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE;AACnC,EAAE,MAAM,EAAE,IAAI,EAAE,GAAG,IAAI;AACvB,EAAE,IAAI,CAAC,IAAI,IAAI,OAAO,IAAI,KAAK,QAAQ,IAAI,IAAI,CAAC,IAAI,EAAE,CAAC,MAAM,KAAK,CAAC,EAAE;AACrE,IAAI,OAAO,IAAI,CAAC,EAAE,KAAK,EAAE,0BAA0B,EAAE,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AACvE,EAAE;AACF,EAAE,IAAI,IAAI,CAAC,MAAM,GAAG,GAAG,EAAE;AACzB,IAAI,OAAO,IAAI,CAAC,EAAE,KAAK,EAAE,6CAA6C,EAAE,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAC1F,EAAE;AACF,EAAE,MAAM,CAAC,OAAO,CAAC,GAAG,MAAM,EAAE,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC,MAAM,CAAC;AACrD,IAAI,MAAM,EAAE,IAAI,CAAC,EAAE;AACnB,IAAI,IAAI,EAAE,IAAI,CAAC,IAAI;AACnB,GAAG,CAAC,CAAC,SAAS,EAAE;AAChB,EAAE,MAAM,EAAE,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,MAAM;AAC/B,IAAI,wBAAwB,CAAC,GAAG,CAAC,CAAC,IAAI,MAAM;AAC5C,MAAM,SAAS,EAAE,OAAO,CAAC,EAAE;AAC3B,MAAM,IAAI,EAAE,IAAI,CAAC,IAAI;AACrB,MAAM,OAAO,EAAE,IAAI,CAAC;AACpB,KAAK,CAAC;AACN,GAAG;AACH,EAAE,OAAO,IAAI,CAAC,EAAE,OAAO,EAAE,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAC3C;;;;"}