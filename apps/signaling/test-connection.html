<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signaling Server Test</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 {
            color: #4ec9b0;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
        }
        button:hover {
            background: #1177bb;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        input {
            background: #2d2d2d;
            border: 1px solid #555;
            color: #d4d4d4;
            padding: 8px;
            font-size: 14px;
            width: 200px;
            border-radius: 4px;
        }
        #log {
            background: #252526;
            border: 1px solid #555;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            border-radius: 4px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid transparent;
        }
        .log-success {
            border-left-color: #4ec9b0;
            color: #4ec9b0;
        }
        .log-error {
            border-left-color: #f48771;
            color: #f48771;
        }
        .log-info {
            border-left-color: #569cd6;
            color: #569cd6;
        }
        .log-warning {
            border-left-color: #dcdcaa;
            color: #dcdcaa;
        }
        .controls {
            margin: 20px 0;
            padding: 20px;
            background: #252526;
            border-radius: 4px;
        }
        .status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status.connected {
            background: #4ec9b0;
        }
        .status.disconnected {
            background: #f48771;
        }
    </style>
</head>
<body>
    <h1>ðŸŽ® Signaling Server Test Client</h1>

    <div class="controls">
        <h3>
            <span class="status" id="status"></span>
            Connection Status: <span id="statusText">Disconnected</span>
        </h3>

        <div style="margin: 20px 0;">
            <input type="text" id="serverUrl" value="http://localhost:3001" placeholder="Server URL">
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()">Disconnect</button>
        </div>

        <div style="margin: 20px 0;">
            <h4>Host Actions:</h4>
            <input type="text" id="shareCodeInput" value="ABC123" placeholder="Share Code (6 chars)">
            <button onclick="createRoom()" id="createBtn" disabled>Create Room</button>
        </div>

        <div style="margin: 20px 0;">
            <h4>Client Actions:</h4>
            <input type="text" id="joinCodeInput" value="ABC123" placeholder="Share Code">
            <button onclick="joinRoom()" id="joinBtn" disabled>Join Room</button>
        </div>

        <div style="margin: 20px 0;">
            <h4>WebRTC Signaling:</h4>
            <button onclick="sendSignal()" id="signalBtn" disabled>Send Test Signal</button>
        </div>

        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div id="log"></div>

    <script>
        let socket = null;
        let currentRoom = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function updateStatus(connected) {
            const status = document.getElementById('status');
            const statusText = document.getElementById('statusText');

            status.className = connected ? 'status connected' : 'status disconnected';
            statusText.textContent = connected ? 'Connected' : 'Disconnected';

            document.getElementById('createBtn').disabled = !connected;
            document.getElementById('joinBtn').disabled = !connected;
            document.getElementById('signalBtn').disabled = !connected || !currentRoom;
        }

        function connect() {
            const serverUrl = document.getElementById('serverUrl').value;

            log(`Connecting to ${serverUrl}...`, 'info');

            socket = io(serverUrl, {
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                log(`âœ“ Connected! Socket ID: ${socket.id}`, 'success');
                updateStatus(true);
            });

            socket.on('disconnect', () => {
                log('âœ— Disconnected', 'error');
                updateStatus(false);
                currentRoom = null;
            });

            socket.on('room-created', (data) => {
                log(`âœ“ Room created: ${data.shareCode}`, 'success');
                currentRoom = data.shareCode;
                document.getElementById('signalBtn').disabled = false;
            });

            socket.on('room-joined', (data) => {
                log(`âœ“ Joined room: ${data.shareCode} (${data.playerCount} players)`, 'success');
                currentRoom = data.shareCode;
                document.getElementById('signalBtn').disabled = false;
            });

            socket.on('client-joined', (data) => {
                log(`â†’ Client joined: ${data.clientId} (${data.playerCount} players)`, 'info');
            });

            socket.on('client-left', (data) => {
                log(`â† Client left: ${data.clientId} (${data.playerCount} players remaining)`, 'info');
            });

            socket.on('host-disconnected', () => {
                log('âš  Host disconnected - room closed', 'warning');
                currentRoom = null;
                document.getElementById('signalBtn').disabled = true;
            });

            socket.on('signal', (data) => {
                log(`ðŸ“¡ Signal received from ${data.from}: ${JSON.stringify(data.signal)}`, 'info');
            });

            socket.on('error', (data) => {
                log(`âœ— Error: ${data.message} (${data.code || 'unknown'})`, 'error');
            });

            socket.on('warning', (data) => {
                log(`âš  Warning: ${data.message}`, 'warning');
            });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                currentRoom = null;
                log('Disconnected manually', 'info');
                updateStatus(false);
            }
        }

        function createRoom() {
            const shareCode = document.getElementById('shareCodeInput').value.toUpperCase();

            if (!shareCode || shareCode.length !== 6) {
                log('âœ— Share code must be 6 characters', 'error');
                return;
            }

            if (!socket || !socket.connected) {
                log('âœ— Not connected to server', 'error');
                return;
            }

            log(`Creating room with code: ${shareCode}...`, 'info');
            socket.emit('create-room', {
                shareCode: shareCode,
                hostId: 'test-host'
            });
        }

        function joinRoom() {
            const shareCode = document.getElementById('joinCodeInput').value.toUpperCase();

            if (!shareCode || shareCode.length !== 6) {
                log('âœ— Share code must be 6 characters', 'error');
                return;
            }

            if (!socket || !socket.connected) {
                log('âœ— Not connected to server', 'error');
                return;
            }

            log(`Joining room: ${shareCode}...`, 'info');
            socket.emit('join-room', {
                shareCode: shareCode,
                clientId: 'test-client'
            });
        }

        function sendSignal() {
            if (!currentRoom) {
                log('âœ— Not in a room', 'error');
                return;
            }

            const testSignal = {
                type: 'offer',
                sdp: 'v=0\r\no=- 123456789 2 IN IP4 127.0.0.1\r\n...(mock SDP)'
            };

            log(`Sending test signal to room ${currentRoom}...`, 'info');
            socket.emit('signal', {
                shareCode: currentRoom,
                signal: testSignal
            });
        }

        // Initialize
        updateStatus(false);
        log('Ready to test signaling server', 'info');
        log('Instructions:', 'info');
        log('1. Make sure signaling server is running (pnpm dev)', 'info');
        log('2. Click "Connect" to connect to server', 'info');
        log('3. Open two browser tabs side by side', 'info');
        log('4. In tab 1: Click "Create Room" (host)', 'info');
        log('5. In tab 2: Click "Join Room" with same code (client)', 'info');
        log('6. Click "Send Test Signal" to test WebRTC signaling', 'info');
    </script>
</body>
</html>
